<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>استعلام امتیاز بازاریاب</title>
</head>
<body>
  <h3>استعلام امتیاز بازاریاب</h3>
  <form id="marketerForm" target="hiddenFrame" onsubmit="handleSubmit(event)">
    <input type="text" name="code" id="codeInput" placeholder="کد بازاریابی (۵ رقمی)">
    <button type="submit">بررسی</button>
  </form>
  <p id="result"></p>
  <iframe name="hiddenFrame" style="display:none;" onload="handleResponse()"></iframe>

  <script>
    let lastCode = "";

    function handleSubmit(e) {
      e.preventDefault();
      const code = document.getElementById("codeInput").value.trim();
      if (!/^\d{5}$/.test(code)) {
        document.getElementById("result").textContent = "لطفاً یک کد ۵ رقمی وارد کنید.";
        return;
      }
      lastCode = code;
      document.getElementById("result").textContent = "در حال بررسی...";
      document.getElementById("marketerForm").action = `https://script.google.com/macros/s/AKfycbwIvuczZd7yczzDvHH6kv512H-2P93iHS7YdCLRY-gSu1Qmrclm-jSQwjkYQUYOnHmfAA/exec?code=${code}`;
    }

    async function handleResponse() {
      if (!lastCode) return;
      try {
        const res = await fetch(`https://script.google.com/macros/s/AKfycbwIvuczZd7yczzDvHH6kv512H-2P93iHS7YdCLRY-gSu1Qmrclm-jSQwjkYQUYOnHmfAA/exec?code=${lastCode}`);
        const data = await res.json();
        if (data.error) {
          document.getElementById("result").textContent = data.error;
        } else {
          document.getElementById("result").textContent = `نام: ${data.name} | امتیاز: ${data.score}`;
        }
      } catch {
        document.getElementById("result").textContent = "خطا در دریافت پاسخ.";
      }
    }
  </script>
</body>
</html>
